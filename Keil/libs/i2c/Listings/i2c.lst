C51 COMPILER V9.56.0.0   I2C                                                               08/04/2017 14:18:36 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\i2c.obj
COMPILER INVOKED BY: C:\Keil\ARM\C51\BIN\C51.EXE i2c.c OPTIMIZE(8,SPEED) DEBUG OBJECTEXTEND PRINT(.\Listings\i2c.lst) OB
                    -JECT(.\Objects\i2c.obj)

line level    source

   1          /*==========================================================================
   2            名称：IIC协议 
   3            编写：aiken
   4            修改：无
   5            内容：函数是采用软件延时的方法产生SCL脉冲，固对高晶振频率要作一定的修
             -
   6                 (本例是1us机器周期，即晶振频率要小于12MHZ)
   7          ============================================================================*/ 
   8          
   9          #include "i2c.h"
  10          
  11          bit ack;
  12          
  13          void i2c_wait()
  14          {
  15   1        unsigned char i;
  16   1        while((SCL==0)&&(++i<250));
  17   1      }
  18          
  19          void i2c_delay()
  20          {
  21   1          _nop_();
  22   1          _nop_();
  23   1          _nop_();
  24   1          _nop_();
  25   1          _nop_();
  26   1      }
  27          
  28          void i2c_init()
  29          {
  30   1          SDA = 1;
  31   1          SCL = 1;
  32   1          i2c_delay();
  33   1      }
  34          
  35          /*=================================================
  36                              启动总线
  37          ==================================================*/
  38          void i2c_start()
  39          {
  40   1          SDA = 1;       //发送起始条件的数据信号
  41   1          i2c_delay();
  42   1          SCL = 1;
  43   1          i2c_delay();   //起始条件建立时间大于4.7us,延时
  44   1          SDA = 0;       //发送起始信号
  45   1          i2c_delay();   //起始条件锁定时间大于4μ
  46   1          SCL = 0;       //钳住I2C总线，准备发送或接收数据
  47   1      }
  48          
  49          /*=================================================
  50                              结束总线
  51          ==================================================*/
  52          void i2c_stop()
  53          {
C51 COMPILER V9.56.0.0   I2C                                                               08/04/2017 14:18:36 PAGE 2   

  54   1          SDA = 0;       //发送结束条件的数据信号
  55   1          i2c_delay();
  56   1          SCL = 1;
  57   1          i2c_delay();   //结束条件建立时间大于4μ
  58   1          SDA = 1;       //发送I2C总线结束信号
  59   1          i2c_delay();
  60   1      }
  61          
  62          /*=====================================================================
  63                                 发送一个字节数据               
  64          函数原型: bit iic_send_byte(unsigned char byte);
  65          功能: 将数据byte发送出去,可以是地址,也可以是数据,发完后等待应答,并对
  66                此状态位进行操作.(不应答或非应答都使ack=0 假)     
  67                发送数据正常，ack=1; ack=0表示被控器无应答或损坏。
  68          ======================================================================*/
  69          bit i2c_write(unsigned char byte)
  70          {
  71   1          unsigned char i;
  72   1              
  73   1          for(i = 0; i < 8; i++)    //要传送的数据长度为8位
  74   1          {
  75   2              SDA = byte & 0x80;    //判断发送位
  76   2              SCL = 1;              //置时钟线为高，通知被控器开始接收数据位
  77   2              i2c_delay();          //保证时钟高电平周期大于4μ
  78   2              SCL = 0;
  79   2              byte <<= 1;
  80   2          }
  81   1              
  82   1              SCL = 1;
  83   1              SDA = 1;                  //8位发送完后释放数据线，准备接收应答位
  84   1          //i2c_wait();
  85   1              i2c_delay();
  86   1              if(0 == SDA)              //判断是否接收到应答信号
  87   1              {
  88   2                  ack = 1;
  89   2              }
  90   1              else
  91   1              {
  92   2                  ack = 0;
  93   2              }
  94   1              
  95   1              SCL = 0;
  96   1              return ack;
  97   1      }
  98          
  99          /*===================================================================================
 100                                       接受一个字节数据               
 101          函数原型: unsigned char iic_receive_byte();
 102          功能:  用来接收从器件传来的数据,并判断总线错误(不发应答信号)，发完后请用
             -答函数。  
 103          ====================================================================================*/  
 104          unsigned char i2c_read()
 105          {
 106   1          unsigned char i;
 107   1              unsigned char a;
 108   1              unsigned char temp = 0;
 109   1              
 110   1              SDA = 1;                      //置数据线为输入方式
 111   1              
 112   1              for(i = 0; i < 8; i++)
 113   1              {
 114   2                  SCL = 0;                  //置时钟线为低，准备接收数据位
C51 COMPILER V9.56.0.0   I2C                                                               08/04/2017 14:18:36 PAGE 3   

 115   2                      i2c_delay();              //时钟低电平周期大于4.7us
 116   2                      SCL = 1;                  //置时钟线为高使数据线上数据有效
 117   2                      
 118   2                      if(SDA)
 119   2                      {
 120   3                          a = 1;
 121   3                      }
 122   2                      else
 123   2                      { 
 124   3                          a = 0;
 125   3                      }
 126   2                      
 127   2                      temp |= (a << (7 - i));   //读数据位,接收的数据位放入retc中
 128   2                      i2c_delay();
 129   2              }
 130   1              SCL = 0;
 131   1              return temp;
 132   1      }
 133          
 134          /*===============================================================
 135                                   应答子函数
 136          ================================================================*/
 137          void i2c_ack()
 138          {
 139   1          SDA = 0;
 140   1              SCL = 1;
 141   1              i2c_delay();    //时钟低电平周期大于4μ
 142   1              SCL = 0;        //清时钟线，钳住I2C总线以便继续接收
 143   1      }
 144          
 145          /*================================================================
 146                                  非应答子函数
 147          =================================================================*/
 148          void i2c_noack()
 149          {
 150   1          SDA = 1;
 151   1              SCL = 1;
 152   1              i2c_delay();    //时钟低电平周期大于4μ
 153   1              SCL = 0;        //清时钟线，钳住I2C总线以便继续接收
 154   1      }
 155          
 156          /*===========================================================================================
 157                                 向有子地址器件发送多字节数据函数               
 158          函数原型: bit iic_send_str(unsigned char addr, unsigned char pos, unsigned char *str, unsigned char le
             -n);  
 159          功能: 从启动总线到发送地址，子地址，数据，结束总线的全过程。
 160                从器件地址addr，子地址pos，发送内容是str指向的内容，发送len个字节。
 161                如果返回1表示操作成功，否则操作有误。
 162          注意：使用前必须已结束总线。
 163          =============================================================================================*/
 164          bit i2c_write_str(unsigned char addr, unsigned char pos, unsigned char *str, unsigned char len)
 165          {
 166   1          unsigned char i;
 167   1              
 168   1              i2c_start();                //启动总线
 169   1              
 170   1              i2c_write(addr);         //发送器件地址
 171   1              if(0 == ack)
 172   1              {
 173   2                  return ERR;
 174   2              }
 175   1              
C51 COMPILER V9.56.0.0   I2C                                                               08/04/2017 14:18:36 PAGE 4   

 176   1              i2c_write(pos);        //发送器件子地址
 177   1              if(0 == ack)
 178   1              {
 179   2                  return ERR;
 180   2              }
 181   1              
 182   1              for(i = 0; i < len; i++)
 183   1              {
 184   2                  i2c_write(*str);    //发送数据
 185   2                      i2c_delay();            //必须延时等待芯片内部自动处理数据完毕
 186   2                      
 187   2                      if(0 == ack)
 188   2                      {
 189   3                          return ERR;
 190   3                      }
 191   2                      
 192   2                      str++;
 193   2              }
 194   1              
 195   1              i2c_stop();                 //结束总线
 196   1              return SUCC;
 197   1      }
 198          
 199          /*===========================================================================================
 200                                  向有子地址器件读取多字节数据函数               
 201          函数原型: bit iic_receive_str(unsigned char addr, unsigned char pos, unsigned char *str, unsigned char
             - len); 
 202          功能: 从启动总线到发送地址，子地址，读数据，结束总线的全过程。
 203                从器件地址addr，子地址pos，读出的内容放入str指向的存储区，读len个字节。
 204                如果返回1表示操作成功，否则操作有误。
 205          注意：使用前必须已结束总线。
 206          =============================================================================================*/
 207          bit i2c_read_str(unsigned char addr, unsigned char pos, unsigned char* str, unsigned char len)
 208          {
 209   1          unsigned char i;
 210   1              
 211   1              i2c_start();                     //启动总线
 212   1              
 213   1              i2c_write(addr);              //发送器件地址
 214   1              if(0 == ack)
 215   1              {
 216   2                  return ERR;
 217   2              }
 218   1              
 219   1              i2c_write(pos);             //发送器件子地址
 220   1              if(0 == ack)
 221   1              {
 222   2                  return ERR;
 223   2              }
 224   1              
 225   1              i2c_start();
 226   1              i2c_write(addr + 1); // read mode
 227   1              if(0 == ack)
 228   1              {
 229   2                  return ERR;
 230   2              }
 231   1              
 232   1              for(i = 0; i < len - 1; i++)
 233   1              {
 234   2                  *str = i2c_read();   //发送数据
 235   2                      i2c_ack();                   //发送就答位 
 236   2                      str++;
C51 COMPILER V9.56.0.0   I2C                                                               08/04/2017 14:18:36 PAGE 5   

 237   2              }
 238   1              
 239   1              *str = i2c_read();
 240   1              i2c_noack();                     //发送非应位
 241   1              i2c_stop();                      //结束总线
 242   1              return SUCC;
 243   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    318    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      14
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
